syntax = "proto3";

package gidyon.mpesa;

option go_package="github.com/gidyon/mpesapayments/pkg/api/mpesapayment";

import "google/api/annotations.proto";
import "google/protobuf/empty.proto";
import "google/api/field_behaviour.proto";
import "protoc-gen-swagger/options/annotations.proto";

message MPESAPayment {
	option (grpc.gateway.protoc_gen_swagger.options.openapiv2_schema) = {
		json_schema: {
			title: "MPESAPayment"
			description: "Lipa na MPESA Payment information"
		}
	};

	string payment_id = 1;
	string transaction_type = 2;
	string transaction_id = 3;
	string msisdn = 4;
	string names = 5;
	string ref_number = 6;
	int64 transaction_timestamp = 7;
	int64 create_timestamp = 8;
	float amount = 9;
	float org_balance = 10;
	int32 business_short_code = 11;
	bool processed = 12;
}

message CreateMPESAPaymentRequest {
	option (grpc.gateway.protoc_gen_swagger.options.openapiv2_schema) = {
		json_schema: {
			title: "CreateMPESAPaymentRequest"
			description: "Request to create record of mpesa payment"
			required: ["mpesa_payment"]
		}
	};

	MPESAPayment mpesa_payment = 1 [(google.api.field_behavior) = REQUIRED];
	bool publish = 2;
}

message CreateMPESAPaymentResponse {
	option (grpc.gateway.protoc_gen_swagger.options.openapiv2_schema) = {
		json_schema: {
			title: "CreateMPESAPaymentResponse"
			description: "Response after creating payment containing payment id"
		}
	};

	string payment_id = 1;
}

message GetMPESAPaymentRequest {
	option (grpc.gateway.protoc_gen_swagger.options.openapiv2_schema) = {
		json_schema: {
			title: "GetMPESAPaymentRequest"
			description: "Request to retrieve mpesa payment"
			required: ["payment_id"]
		}
	};

	string payment_id = 1 [(google.api.field_behavior) = REQUIRED];
}

enum ProcessedState {
	PROCESS_STATE_UNSPECIFIED = 0;
	PROCESSED = 1;
	NOT_PROCESSED = 2;
}

message ListMPESAPaymentsFilter {
	option (grpc.gateway.protoc_gen_swagger.options.openapiv2_schema) = {
		json_schema: {
			title: "ListMPESAPaymentsFilter"
			description: "Filter payload for querying payments"
		}
	};
	
	string tx_date = 1;
	repeated string msisdns = 2;
	repeated string accounts_number = 3;
	ProcessedState process_state = 4;
	float amount = 5;
	int64 start_timestamp = 6;
	int64 end_timestamp = 7;
}

message ListMPESAPaymentsRequest {
	option (grpc.gateway.protoc_gen_swagger.options.openapiv2_schema) = {
		json_schema: {
			title: "ListMPESAPaymentsRequest"
			description: "Request to retrieve a collection of mpesa payments"
		}
	};

	string page_token = 1;
	int32 page_size = 2;
	ListMPESAPaymentsFilter filter = 3;
}

message ListMPESAPaymentsResponse {
	option (grpc.gateway.protoc_gen_swagger.options.openapiv2_schema) = {
		json_schema: {
			title: "ListMPESAPaymentsResponse"
			description: "Reponse containing a collection of mpesa payments"
		}
	};

	string next_page_token = 1;
	repeated MPESAPayment mpesa_payments = 2;
}

message Scopes {
	option (grpc.gateway.protoc_gen_swagger.options.openapiv2_schema) = {
		json_schema: {
			title: "Scopes"
			description: "Identities that is allowed access"
		}
	};

	repeated string allowed_phones = 1;
	repeated string allowed_acc_number = 2;
}

message AddScopesRequest {
	option (grpc.gateway.protoc_gen_swagger.options.openapiv2_schema) = {
		json_schema: {
			title: "AddScopesRequest"
			description: "Request to add scopes"
			required: ["user_id", "scopes"]
		}
	};

	string user_id = 1 [(google.api.field_behavior) = REQUIRED];
	Scopes scopes = 2 [(google.api.field_behavior) = REQUIRED];
}

message AddScopesResponse {
	option (grpc.gateway.protoc_gen_swagger.options.openapiv2_schema) = {
		json_schema: {
			title: "AddScopesResponse"
			description: "Response containing scopes"
		}
	};

	Scopes scopes = 1;
}

message GetScopesRequest {
	option (grpc.gateway.protoc_gen_swagger.options.openapiv2_schema) = {
		json_schema: {
			title: "GetScopesRequest"
			description: "Request to scopes for an identity"
			required: ["user_id"]
		}
	};

	string user_id = 1 [(google.api.field_behavior) = REQUIRED];
}

message GetScopesResponse {
	option (grpc.gateway.protoc_gen_swagger.options.openapiv2_schema) = {
		json_schema: {
			title: "GetScopesResponse"
			description: "Reponse containing scopes"
		}
	};

	Scopes scopes = 1;
}

message ProcessMpesaPaymentRequest {
	option (grpc.gateway.protoc_gen_swagger.options.openapiv2_schema) = {
		json_schema: {
			title: "ProcessMpesaPaymentRequest"
			description: "Request to update Mpesa transaction processed state"
		}
	};

	string payment_id = 1;
	bool state = 2;
	bool retry = 3;
}

message PublishMpesaPaymentRequest {
	option (grpc.gateway.protoc_gen_swagger.options.openapiv2_schema) = {
		json_schema: {
			title: "PublishMpesaPaymentRequest"
			description: "Request to publish an mpesa transaction for listerners to process"
		}
	};

	string payment_id = 1;
	string initiator_id = 2;
	ProcessedState processed_state = 3;
}

message PublishAllMpesaPaymentRequest {
	option (grpc.gateway.protoc_gen_swagger.options.openapiv2_schema) = {
		json_schema: {
			title: "PublishAllMpesaPaymentRequest"
			description: "Update Mpesa tx processed state to either true or false"
		}
	};
	
	ProcessedState processed_state = 1;
	int64 start_timestamp = 2;
	int64 end_timestamp = 3;
}

message GetTransactionsCountRequest {
	option (grpc.gateway.protoc_gen_swagger.options.openapiv2_schema) = {
		json_schema: {
			title: "GetTransactionsCountRequest"
			description: "Request to retrieve transactions information"
		}
	};

	repeated string accounts_number = 1;
	repeated string msisdns = 2;
	int64 start_time_seconds = 3;
	int64 end_time_seconds = 4;
	float amount = 5 [(google.api.field_behavior) = REQUIRED];
}

message TransactionsSummary {
	option (grpc.gateway.protoc_gen_swagger.options.openapiv2_schema) = {
		json_schema: {
			title: "TransactionsSummary"
			description: "Transactions summary"
		}
	};

	float total_amount = 1;
	int32 transactions_count = 2;
}

// Stores and retrieves LIPA NA MPESA payments 
service LipaNaMPESA {
	// Creates a record of mpesa payment.
	rpc CreateMPESAPayment (CreateMPESAPaymentRequest) returns (CreateMPESAPaymentResponse) {
		option (google.api.http) = {
			post: "/api/mpestx/payments"
			body: "*"
		};
	};

	// Retrieves MPESA payment.
	rpc GetMPESAPayment (GetMPESAPaymentRequest) returns (MPESAPayment) {
		option (google.api.http) = {
			get: "/api/mpestx/payments/{payment_id}"
		};
	};

	// Retrieves a collection of MPESA payments.
	rpc ListMPESAPayments (ListMPESAPaymentsRequest) returns (ListMPESAPaymentsResponse) {
		option (google.api.http) = {
			get: "/api/mpestx/payments"
		};
	};

	// Adds scopes to a user.
	rpc AddScopes (AddScopesRequest) returns (google.protobuf.Empty) {
		option (google.api.http) = {
			post: "/api/mpestx/scopes:add"
			body: "*"
		};
	};

	// Retrieves scopes for a user.
	rpc GetScopes (GetScopesRequest) returns (GetScopesResponse) {
		option (google.api.http) = {
			get: "/api/mpestx/scopes/{user_id}"
		};
	};

	// Updates Mpesa transaction processed state to either true or false.
	rpc ProcessMpesaPayment (ProcessMpesaPaymentRequest) returns (google.protobuf.Empty) {
		option (google.api.http) = {
			post: "/api/mpestx/payments/actions/process"
			body: "*"
		};
	};

	// Publishes Mpesa statement for listeners to process. Safe to be called many times.
	rpc PublishMpesaPayment (PublishMpesaPaymentRequest) returns (google.protobuf.Empty) {
		option (google.api.http) = {
			post: "/api/mpestx/payments/actions/publish"
			body: "*"
		};
	};

	// Publish all failed Mpesa transaction for listeners to process.
	rpc PublishAllMpesaPayment (PublishAllMpesaPaymentRequest) returns (google.protobuf.Empty) {
		option (google.api.http) = {
			post: "/api/mpestx/payments/actions/publishall"
			body: "*"
		};
	};

	// Get transactions count summary
	rpc GetTransactionsCount (GetTransactionsCountRequest) returns (TransactionsSummary) {
		option (google.api.http) = {
			get: "/api/mpestx/payments/actions/transactions"
		};
	};

	// Retrives a random transaction using RM=NG algorithm
	rpc GetRandomTransaction (GetRandomTransactionRequest) returns (MPESAPayment) {
		option (google.api.http) = {
			get: "/api/mpestx/payments/actions/get-random-transaction"
		};
	};
}

message GetRandomTransactionRequest {
	option (grpc.gateway.protoc_gen_swagger.options.openapiv2_schema) = {
		json_schema: {
			title: "RandomTransactionRequest"
			description: "Request to a random transaction information"
		}
	};

	repeated string accounts_number = 1;
	int64 start_time_seconds = 2;
	int64 end_time_seconds = 3;
	float amount = 4 [(google.api.field_behavior) = REQUIRED];
}

option (grpc.gateway.protoc_gen_swagger.options.openapiv2_swagger) = {
	info: {
		title: "MPESA Payment Service";
		description: "Gateway to confirm and validate MPESA payments, and a CRUD API for the MpesaPayment resource"
		version: "0.1";
		contact: {
			name: "Github <Gideon Kamau>";
			url: "https://github.com/gidyon/mpesapayments/src/master/";
			email: "gkamau@onfonmedia.com";
		};
		license: {
			name: "BSD 3-Clause License";
			url: "https://github.com/gidyon/mpesapayments/src/master/LICENSE.txt";
		};
	};
	schemes: HTTP;
	schemes: HTTPS;
	consumes: "application/json";
	produces: "application/json";
	security_definitions: {
		security: {
		  key: "bearer"
		  value: {
			type: TYPE_API_KEY
			in: IN_HEADER
			name: "Authorization"
			description: "Authentication token, prefixed by Bearer: Bearer <token>"
		  }
		}
	  }
	  security: {
		security_requirement: {
		  key: "bearer"
		}
	  }
};